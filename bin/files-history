#!/usr/bin/env python
"""
    Usage: files-history [OPTIONS] agave://SYSTEM/PATH

List the event history for a file or directory on a Tapis storage system.

This will give more descriptive information related to number of retries,
permission grants and revocations, reasons for failures, and so on that have
occurred during the data transfer process.

Flags:
  -c, --cachedir    Session cache directory.
"""
from __future__ import print_function
import argparse
import sys
from agavepy.agave import Agave
from agavepy import utils

parser = argparse.ArgumentParser(
    description="List the event history for a file or directory on a Tapis storage system.")

parser.add_argument(
    "-c",
    "--cachedir",
    default=utils.credentials_cache_dir(),
    help="Session cache directory.")

parser.add_argument("filepath", help="Path to list history upon")

if __name__ == "__main__":
    try:
        args = parser.parse_args()

        cache_dir = args.cachedir
        uri = args.filepath
        agave = Agave()
        agave.load_client(cache_dir)

        # Refresh tokens if necessary.
        agave.refresh_tokens()
        # Save out session cache
        if agave.client_name is not None:
            agave.save_configs(cache_dir)

        # Obtain uri - remove the prefix 'agave://'.
        uri = uri[len("agave://"):]

        # List files-history.
        agave.files_history(uri)
        sys.exit(0)

    except Exception as err:
        print(err)
        sys.exit(1)
