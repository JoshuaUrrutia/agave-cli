#!/usr/bin/env python
"""
    Usage: files-list [OPTIONS] agave://SYSTEM/PATH

Lists files on a Tapis storage system.

The path must be specified as an agave URI.
Example:
    files-list -l agave://tacc-data-user/path/to/dir

 Flags:
  -c, --cachedir    Session cache directory.
  -l, --long        Use long listing format
"""
from __future__ import print_function
import argparse
import sys
from agavepy.agave import Agave
from agavepy import utils

parser = argparse.ArgumentParser(
    description="Lists files on a Tapis storage system. The path must be specified as an agave URI (i.e. agave://tacc-data-user/path/to/dir)")

parser.add_argument(
    "-c",
    "--cachedir",
    default=utils.credentials_cache_dir(),
    help="Session cache directory.")

parser.add_argument(
    "-l", "--long", action="store_true", help="Use long listing format.")

parser.add_argument("filepath", help="Path to list")

if __name__ == "__main__":
    try:
        args = parser.parse_args()

        cache_dir = args.cachedir
        long_format = args.long
        uri = args.filepath
        agave = Agave()
        agave.load_client(cache_dir)

        # Refresh tokens if necessary.
        agave.refresh_tokens()
        # Save out session cache
        if agave.client_name is not None:
            agave.save_configs(cache_dir)

        # Obtain uri - remove the prefix 'agave://'.
        uri = uri[len("agave://"):]

        # List files on remote system.
        agave.files_list(uri, long_format=long_format)
        sys.exit(0)

    except Exception as err:
        print(err)
        sys.exit(1)
